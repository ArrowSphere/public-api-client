# Billing preferences client

## General information

This API will allow you to access and edit your preferences and retrieve your custom billing statements.

## Entities

### Preference

The `Preference` entity allows to manage the company's main contact:

| Field      | Type      | Example                          | Description                                                                                          |
| ---------- | --------- | -------------------------------- | ---------------------------------------------------------------------------------------------------- |
| name       | `string`  | Rule1                            |                                                                                                      |
| priority   | `numeric` | 2                                | 0 is the highest priority                                                                            |
| identifier | `string`  | GroupBy                          | Preference type (see below for the full list of types)                                               |
| parameters | `array`   | [ columns => ... ]               | Associative list of parameters (depends on the type)                                                 |
| filters    | `array`   | [ CustomerXspRef => [ XSP123 ] ] | Associative list of column filters. Available columns: CustomerXspRef, VendorName and Classification |
| overrides  | `array`   | [ ArsSku => SKU ]                | Associative list of column overrides, ArsSku is mandatory                                            |

## Preference Types

The `identifier` field can be one of thoses preference types:

### GroupBy

For the GroupBy type, you must set a list of columns in the `parameters` field.

| Parameter | Type    | Example           | Description               |
| --------- | ------- | ----------------- | ------------------------- |
| columns   | `array` | [ ResourceGroup ] | List of groupable columns |

Available columns:

- CreatedBy
- ResourceGroup
- Name
- CostCenter
- Project
- Application
- Environment
- CustomTag
- SubscriptionFriendlyName
- ArsSubscriptionId

## Usage

### Initialization

The "billing preferences" client is simply called `PreferencesClient`.
You can get it through the main entry point `PublicApiClient` and its method `getBillingPreferencesClient()`, or instanciate it directly:

```php
<?php

use ArrowSphere\PublicApiClient\Billing\PreferencesClient;

const URL = 'https://your-url-to-arrowsphere.example.com';
const API_KEY = 'your API key in ArrowSphere';

$client = (new PreferencesClient())
    ->setUrl(URL)
    ->setApiKey(API_KEY);
```

### List all the preferences

You can list all the preferences by calling the `getPreferences()` method.

This method returns an instance of `Preferences` entity.
Use the `getList` method from the `Preferences` entity to list all the preferences.

Example:

```php
<?php

$period = '2021-04';
$preferences = $client->getPreferences($period)->getList();
foreach ($preferences as $preference) {
    echo $preference->getIdentifier() . PHP_EOL;
}
```

### Create preferences

You can create a new list of preferences by calling the `createPreferences()` method.

Note: You can't create preferences in the past.

Example:

```php
<?php

use ArrowSphere\PublicApiClient\Billing\Entities\Preference;
use ArrowSphere\PublicApiClient\Billing\Enum\PreferenceGroupByColumnsEnum;
use ArrowSphere\PublicApiClient\Billing\Enum\PreferenceTypeEnum;

$period = '2021-04';
$preferences = [new Preference([
    Preference::KEY_NAME => 'rule1',
    Preference::KEY_IDENTIFIER => PreferenceTypeEnum::GROUP_BY,
    Preference::KEY_PRIORITY => 1,
    Preference::KEY_PARAMETERS => [
        Preference::KEY_COLUMNS => [
            PreferenceGroupByColumnsEnum::CREATED_BY
        ],
    ],
    Preference::KEY_FILTERS => [],
    Preference::KEY_OVERRIDES => [
        'ArsSku' => 'sku',
    ]
])];

$client->createPreferences($period, $preferences);
```
